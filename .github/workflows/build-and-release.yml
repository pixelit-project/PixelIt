name: Build, Release & Deploy

on:
  [push]

env:
  prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'testing') }}
      
jobs:
  build-webui:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          repository: 'pixelit-project/WebUI'

      - name: Use Node.js ğŸ’¾
        uses: actions/setup-node@v1
        with:
          node-version: 19.x

      - name: Install dependencies ğŸ”§
        run: npm install

      - name: Build WebUI ğŸ—ï¸
        run: npm run build

      - name: Upload build artifacts ğŸ’¾
        uses: actions/upload-artifact@v3
        with:
          name: pixelit-webui
          path: dist

  build-fw:
    needs: build-webui
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Cache pip ğŸ’¾
        uses: actions/cache@v2
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache PlatformIO ğŸ’¾
        uses: actions/cache@v2
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}

      - name: Set up Python ğŸ
        uses: actions/setup-python@v4

      - name: Download WebUI artifacts ğŸ’¾
        uses: actions/download-artifact@v3
        with:
          name: pixelit-webui
          path: pixelit-webui-artifact

      - name: Update webinterface.h  ğŸ”§
        run: |
          python .github/webui.py

      - name: Update version in PixelIt.ino ğŸ”§
        run: |
          python .github/updateversion.py ${{  github.ref_name }}

      - name: Install pio and its dependencies ğŸ”§
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Run PlatformIO build on selected platforms ğŸ—ï¸
        run: platformio run -e d1_mini -e ESP8266 -e wemos_d1_mini32 -e nodemcuv2

      - name: Upload build artifacts ğŸ’¾
        uses: actions/upload-artifact@v3
        with:
          name: pixelit-firmware
          path: .pio/build/*/firmware_*.bin

  release-fw:
    needs: build-fw
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts ğŸ’¾
        uses: actions/download-artifact@v3
        with:
          name: pixelit-firmware

      - name: Display structure of downloaded files ğŸ”
        run: ls -R

      - name: Upload binaries as release ğŸš€
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./*/firmware_*.bin
          tag: ${{ github.ref }}
          release_name: ${{ github.ref_name }}
          overwrite: true
          file_glob: true
          prerelease: ${{ env.prerelease }}

  deploy-webui-gh-pages:
    runs-on: ubuntu-latest
    needs: build-webui
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          repository: 'pixelit-project/WebUI'

      - name: Download artifacts ğŸ’¾
        uses: actions/download-artifact@v3
        with:
          name: pixelit-webui
          path: webui

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: . # The folder the action should deploy.
          CLEAN: false # Automatically remove deleted files from the deploy branch
